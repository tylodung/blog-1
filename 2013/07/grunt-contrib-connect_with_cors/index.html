<!doctype html>
<html lang="ja" itemscope itemtype="http://schema.org/Blog">
<head>
    <meta charset="utf-8">
  <title>メモログ</title>
  <meta name="description" content="💡 Personal notes about somthing I&#39;m interested in" id="meta-description">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/blog/css/global.css">
  <script>window.lazyLoadOptions = {};</script>
<link rel="stylesheet" href="/blog/css/prism.css" type="text/css">
<link rel="stylesheet" href="/blog/css/prism-line-numbers.css" type="text/css"></head>
<body>
    <header class="header header_component_global">
    <div class="header__title header__title"><a href="/blog/">メモログ</a></div>
    <p class="header__description">💡 Personal notes about somthing I&#39;m interested in</p>
    <aside><blockquote class="header__epigraph">Well, he fuffed, and he puffed, and he huffed and he puffed, and he puffed and huffed; but he could not get the house down.</blockquote></aside>
    <nav class="navigation navigation-global">
      <a href="/blog/" class="navigation__link">📘 Latest Articles</a>
    </nav>
  </header>
  <div class="container">
    <main class="main">
      <article itemprop="blogPost" itemscope itemType="http://schema.org/BlogPosting">
        <header class="header">
          <h1 class="header__title" itemprop="name">grunt-contrib-connect タスクで CORS を有効にする</h1>
          <div>
            <time datetime="2013-07-31T02:00:00.000Z" itemprop="datePublished">
              <span class="calendar-icon">📅</span><span>2013年7月31日</span>
            </time>
          </div>
          
        </header>
        <div id="article-content" class="content" itemprop="articleBody"><p><a href="https://github.com/gruntjs/grunt-contrib-jasmine" target="_blank" rel="noopener">grunt-contrib-jasmine</a>のThird party templatesにある<a href="https://github.com/maenu/grunt-template-jasmine-istanbul" target="_blank" rel="noopener">Code coverage output with Istanbul</a>を使ってjasmineテストのcoverageの計測をしようとしているのですが、XMLHttpRequestを実行するところでCross Originの制約にひっかかってエラーになってしまう。localhostで実行されるのが理由かなとは思われるのですが、普通にjasmineテストを実行した場合はひっかからない不思議…（エラーに「file://」が出ているのも不明） jasmineのcoverage用のタスクのオプションでhostをlocalhostに指定していなかったためだった。そのため、localfile system (file://) で起動していた… 設定を追加したらCORSの設定は必要なかった。</p>
<a id="more"></a>
<p>XMLHttpRequest cannot load <a href="http://localhost:9002/foobar.js" target="_blank" rel="noopener">http://localhost:9002/foobar.js</a>.<br>Origin file:// is not allowed by Access-Control-Allow-Origin.</p>
<p>理由はさておき、Access-Control-Allow-Origin（<a href="https://developer.mozilla.org/ja/docs/HTTP_access_control" target="_blank" rel="noopener">HTTP access control (CORS)</a>参考）を設定すれば、エラーを抑制できるはず（<a href="http://stackoverflow.com/questions/10143093/origin-is-not-allowed-by-access-control-allow-origin" target="_blank" rel="noopener">javascript - Origin is not allowed by Access-Control-Allow-Origin - Stack Overflow</a>も参考）。<a href="https://github.com/gruntjs/grunt-contrib-connect" target="_blank" rel="noopener">grunt-contrib-connect</a>でサーバーを立ち上げてPhantomJSがそこからJasmine specsを実行するようにしているので、grunt-contrib-connectにCORSの設定をする。</p>
<p>grunt-contrib-connectで立ち上げたサーバーのheaderにAccess-Control-Allow-Originを追加するには… middlewareのオプションを使うと良いらしい。middlewareのオプションは、returnにfunctionの配列を渡すことで、渡したfunctionを順繰り実行してくれるみたい。Access-Control-Allow-Originの追加方法は、<a href="https://gist.github.com/Vp3n/5340891" target="_blank" rel="noopener">Allowing CORS (Cross-Origin Resource Sharing) requests from grunt server</a>を参考にしました。このGistのだけだと、<a href="https://github.com/gruntjs/grunt-contrib-connect/blob/master/tasks/connect.js" target="_blank" rel="noopener">grunt-contrib-connectのタスクでデフォルトで設定されているmiddleware</a>が実行されなくなってしまうので、デフォルトで設定されているfunctionも一緒に追加する。すると、こんな感じの設定になる。</p>
<p>test: {<br>  options: {<br>    hostname: ‘localhost’,<br>    port: 9002,<br>    keepalive: true,<br>    middleware: function (connect, options) {<br>      return [<br>        function (req, res, next) {<br>          res.setHeader(‘Access-Control-Allow-Origin’, ‘<em>‘);<br>          res.setHeader(‘Access-Control-Allow-Methods’, ‘</em>‘);<br>          next();<br>        },<br>        // Serve static files.<br>        connect.static(options.base),<br>        // Make empty directories browsable.<br>        connect.directory(options.base)<br>      ];<br>    }<br>  }<br>},</p>
<p>これでCross Originのエラーが発生することなく、coverageの計測が完了するようになりました。</p>
<p>というメモ</p>
</div>
      </article>
    </main>
  </div>
  <script src="/blog/js/lazysizes/lazysizes.min.js" async></script>
</body>
</html>